<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과제 목록 - Ploytech</title>
    <link rel="stylesheet" th:href="@{/css/student/studentStyleSheet.css}">
    <link rel="stylesheet" th:href="@{/css/student/studentAssignmentsSpecific.css}">
</head>
<body>
<div class="header">
    <a class="header-left" th:href="@{/student/main}" style="text-decoration: none;">
        <div class="logo"></div>
        <div class="title">Ploytech 과제 제출 시스템</div>
    </a>
    <div class="user-info">
        <span th:text="${student.name + ' 학생'}">학생</span>
        <span th:text="'(' + ${student.studentId} + ')'">학번</span>
        <a th:href="@{/student/main}" class="back-btn">← 메인으로</a>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <a th:href="@{/student/main}" class="sidebar-item-container">
            <div class="sidebar-item">메인메뉴</div>
        </a>
        <a th:href="@{/student/courses}" class="sidebar-item-container">
            <div class="sidebar-item">수업목록</div>
        </a>
        <a th:href="@{/student/assignments}" class="sidebar-item-container">
            <div class="sidebar-item active">과제 목록</div>
        </a>
        <a th:href="@{/student/submissions}" class="sidebar-item-container">
            <div class="sidebar-item">제출 관리</div>
        </a>
        <a th:href="@{/student/questions}" class="sidebar-item-container">
            <div class="sidebar-item">질문 관리</div>
        </a>
    </div>

    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">📝 과제 목록</div>
            <div class="page-subtitle">내 과제를 한눈에 확인하고 관리하세요</div>
        </div>

        <!-- Error Message -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(assignments)}">0</div>
                <div class="stat-label">전체 과제</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="submittedCount">0</div>
                <div class="stat-label">제출 완료</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">미제출</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="overdueCount">0</div>
                <div class="stat-label">기한 초과</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="statusFilter">상태:</label>
                <select id="statusFilter" class="filter-select" onchange="filterAssignments()">
                    <option value="all">전체</option>
                    <option value="pending">미제출</option>
                    <option value="submitted">제출완료</option>
                    <option value="overdue">기한초과</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="courseFilter">강의:</label>
                <select id="courseFilter" class="filter-select" onchange="filterAssignments()">
                    <option value="all">전체 강의</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortFilter">정렬:</label>
                <select id="sortFilter" class="filter-select" onchange="sortAssignments()">
                    <option value="dueDate">마감일순</option>
                    <option value="createdDate">생성일순</option>
                    <option value="title">제목순</option>
                </select>
            </div>
        </div>

        <!-- Assignments Grid -->
        <div id="assignmentsContainer">
            <div th:if="${#lists.isEmpty(assignments)}" class="empty-state">
                <div class="empty-state-icon">📝</div>
                <h3>아직 과제가 없습니다</h3>
                <p>수업을 등록하면 과제를 확인할 수 있어요!</p>
                <a th:href="@{/student/main}" class="btn-primary">메인으로 돌아가기</a>
            </div>

            <div th:unless="${#lists.isEmpty(assignments)}" class="assignments-grid" id="assignmentsGrid">
                <a th:each="assignment : ${assignments}"
                   class="assignment-card"
                   th:href="@{/student/assignment/{code}(code=${assignment.assignmentCode})}"
                   th:data-status="${assignment.isSubmitted() ? 'submitted' : (assignment.isOverdue() ? 'overdue' : 'pending')}"
                   th:data-course="${assignment.course.courseCode}"
                   th:data-due-date="${assignment.dueDate}"
                   th:data-created-date="${assignment.createdDate}"
                   th:data-title="${assignment.title}">

                    <div class="assignment-header">
                        <h3 class="assignment-title" th:text="${assignment.title}">과제 제목</h3>
                        <span class="status-badge"
                              th:class="${'status-badge ' + (assignment.isSubmitted() ? 'status-submitted' : (assignment.isOverdue() ? 'status-overdue' : 'status-pending'))}"
                              th:text="${assignment.isSubmitted() ? '제출완료' : (assignment.isOverdue() ? '기한초과' : '미제출')}">상태</span>
                    </div>

                    <div class="course-info">
                        <span>📚</span>
                        <span th:text="${assignment.course.courseName}">강의명</span>
                        <span th:text="'(' + ${assignment.course.courseCode} + ')'">강의코드</span>
                    </div>

                    <div class="assignment-description" th:text="${assignment.content}">
                        과제 설명...
                    </div>

                    <div class="assignment-dates">
                        <div class="date-item">
                            <span class="date-icon">📅</span>
                            <span th:text="'생성: ' + ${#temporals.format(assignment.createdDate, 'yyyy-MM-dd HH:mm')}">생성일</span>
                        </div>
                        <div class="date-item">
                            <span class="date-icon">⏰</span>
                            <span th:text="'마감: ' + ${#temporals.format(assignment.dueDate, 'yyyy-MM-dd HH:mm')}">마감일</span>
                        </div>
                    </div>

                    <div class="time-remaining"
                         th:data-due-date="${assignment.dueDate}"
                         th:data-is-submitted="${assignment.isSubmitted()}">
                        시간 계산 중...
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let allAssignments = [];

    document.addEventListener('DOMContentLoaded', function() {
        // 과제 데이터 저장
        const assignmentCards = document.querySelectorAll('.assignment-card');
        allAssignments = Array.from(assignmentCards).map(card => ({
            element: card,
            status: card.dataset.status,
            course: card.dataset.course,
            dueDate: new Date(card.dataset.dueDate),
            createdDate: new Date(card.dataset.createdDate),
            title: card.dataset.title
        }));

        // 강의 필터 옵션 설정
        setupCourseFilter();

        // 통계 업데이트
        updateStatistics();

        // 남은 시간 업데이트
        updateTimeRemaining();

        // 1분마다 시간 업데이트
        setInterval(updateTimeRemaining, 60000);
    });

    function setupCourseFilter() {
        const courseFilter = document.getElementById('courseFilter');
        const courses = new Set();

        allAssignments.forEach(assignment => {
            courses.add(assignment.course);
        });

        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            courseFilter.appendChild(option);
        });
    }

    function updateStatistics() {
        const submitted = allAssignments.filter(a => a.status === 'submitted').length;
        const pending = allAssignments.filter(a => a.status === 'pending').length;
        const overdue = allAssignments.filter(a => a.status === 'overdue').length;

        document.getElementById('submittedCount').textContent = submitted;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('overdueCount').textContent = overdue;
    }

    function filterAssignments() {
        const statusFilter = document.getElementById('statusFilter').value;
        const courseFilter = document.getElementById('courseFilter').value;

        allAssignments.forEach(assignment => {
            let show = true;

            // 상태 필터
            if (statusFilter !== 'all' && assignment.status !== statusFilter) {
                show = false;
            }

            // 강의 필터
            if (courseFilter !== 'all' && assignment.course !== courseFilter) {
                show = false;
            }

            assignment.element.style.display = show ? 'block' : 'none';
        });
    }

    function sortAssignments() {
        const sortBy = document.getElementById('sortFilter').value;
        const container = document.getElementById('assignmentsGrid');

        const sortedAssignments = [...allAssignments].sort((a, b) => {
            switch (sortBy) {
                case 'dueDate':
                    return a.dueDate - b.dueDate;
                case 'createdDate':
                    return b.createdDate - a.createdDate;
                case 'title':
                    return a.title.localeCompare(b.title);
                default:
                    return 0;
            }
        });

        // DOM 재정렬
        sortedAssignments.forEach(assignment => {
            container.appendChild(assignment.element);
        });
    }

    function updateTimeRemaining() {
        const timeElements = document.querySelectorAll('.time-remaining');
        const now = new Date();

        timeElements.forEach(element => {
            const dueDate = new Date(element.dataset.dueDate);
            const isSubmitted = element.dataset.isSubmitted === 'true';
            const timeDiff = dueDate - now;

            if (isSubmitted) {
                element.textContent = '✅ 제출완료';
                element.className = 'time-remaining time-normal';
            } else if (timeDiff <= 0) {
                element.textContent = '⚠️ 기한만료';
                element.className = 'time-remaining time-danger';
            } else {
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

                let timeText = '';
                if (days > 0) {
                    timeText = `${days}일 ${hours}시간 남음`;
                } else if (hours > 0) {
                    timeText = `${hours}시간 ${minutes}분 남음`;
                } else {
                    timeText = `${minutes}분 남음`;
                }

                element.textContent = `⏰ ${timeText}`;

                // 시간에 따른 색상 변경
                if (timeDiff < 24 * 60 * 60 * 1000) { // 24시간 미만
                    element.className = 'time-remaining time-danger';
                } else if (timeDiff < 72 * 60 * 60 * 1000) { // 72시간 미만
                    element.className = 'time-remaining time-warning';
                } else {
                    element.className = 'time-remaining time-normal';
                }
            }
        });
    }

    function viewAssignment(assignmentCode) {
        window.location.href = `/student/assignment/${assignmentCode}`;
    }
</script>
</body>
</html>