<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ì œ ìƒì„¸ - Poly</title>
    <link rel="stylesheet" th:href="@{/css/student/studentStyleSheet.css}">
    <link rel="stylesheet" th:href="@{/css/student/studentAssignmentDetailSpecific.css}">
</head>
<body>
<div class="header">
    <a class="header-left" th:href="@{/student/main}" style="text-decoration: none;">
        <div class="logo"></div>
        <div class="title">AISW</div>
    </a>
    <div class="user-info">
        <span th:text="${student.name + ' í•™ìƒ'}">í•™ìƒ</span>
        <span th:text="'(' + ${student.studentId} + ')'">í•™ë²ˆ</span>
        <a th:href="@{/logout}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<div class="container">
    <div class="main-content">
        <div id="loadingSpinner" class="loading">
            ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>

        <div id="errorAlert" class="alert alert-danger" style="display: none;">
            <strong>ì˜¤ë¥˜!</strong> <span id="errorMessage"></span>
        </div>

        <div id="successAlert" class="alert alert-success" style="display: none;">
            <strong>ì„±ê³µ!</strong> <span id="successMessage"></span>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Assignment Header -->
            <div class="assignment-header">
                <div class="assignment-title" id="assignmentTitle">ê³¼ì œ ì œëª©</div>
                <div class="assignment-meta">
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ“š</span>
                        <span id="courseName">ê°•ì˜ëª…</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ“…</span>
                        <span>ìƒì„±ì¼: <span id="createdDate"></span></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">â°</span>
                        <span>ë§ˆê°ì¼: <span id="dueDate"></span></span>
                    </div>
                    <div class="status-badge" id="statusBadge">ìƒíƒœ</div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="main-grid">
                <!-- Left Side - Assignment Content & Submission -->
                <div class="content-section">
                    <div class="section-title">
                        ğŸ“ ê³¼ì œ ì„¤ëª…
                    </div>
                    <div class="assignment-description" id="assignmentContent">
                        ê³¼ì œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>

                    <!-- Submission Area -->
                    <div class="section-title">
                        ğŸ“‹ ê³¼ì œ ì œì¶œ
                    </div>

                    <div id="submissionArea" class="submission-area">
                        <div id="noSubmission">
                            <h3>ğŸ“¤ ê³¼ì œë¥¼ ì œì¶œí•´ì£¼ì„¸ìš”</h3>
                            <p>ì•„ì§ ì œì¶œí•˜ì§€ ì•Šì€ ê³¼ì œì…ë‹ˆë‹¤.</p>

                            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                            <textarea id="submissionContent" class="textarea-large" placeholder="ê³¼ì œ ë‚´ìš©ì„ ì—¬ê¸°ì— ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>

                            <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                            <div style="margin: 15px 0;">
                                <label for="submissionFile" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">
                                    ğŸ“ íŒŒì¼ ì²¨ë¶€ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="file"
                                       id="submissionFile"
                                       accept=".pdf,.doc,.docx,.txt,.hwp,.zip,.jpg,.jpeg,.png">
                                <div id="submissionFileDisplay"></div>
                                <small style="color: #7f8c8d;">
                                    í—ˆìš© í˜•ì‹: PDF, DOC, DOCX, TXT, HWP, ZIP, JPG, PNG (ìµœëŒ€ 10MB)
                                </small>
                            </div>

                            <div style="margin-top: 15px;">
                                <button class="btn-primary" onclick="submitAssignment()">ì œì¶œí•˜ê¸°</button>
                            </div>
                        </div>

                        <div id="hasSubmission" style="display: none;">
                            <h3>âœ… ì œì¶œ ì™„ë£Œ</h3>
                            <p>ì œì¶œì¼: <span id="submittedDate"></span></p>

                            <!-- ì œì¶œëœ ë‚´ìš© í‘œì‹œ -->
                            <div class="submission-content" id="submittedContent">
                                ì œì¶œëœ ë‚´ìš©...
                            </div>

                            <!-- ì œì¶œëœ íŒŒì¼ ì •ë³´ í‘œì‹œ -->
                            <div id="submittedFileInfo" style="display: none;">
                                <div class="submitted-file-info">
                                    <div class="file-details">
                                        <div class="file-name">ğŸ“ <span id="submittedFileName">íŒŒì¼ëª…</span></div>
                                        <div class="file-size" id="submittedFileSize">íŒŒì¼ í¬ê¸°</div>
                                    </div>
                                    <div class="file-actions">
                                        <button class="btn-download" onclick="downloadFile()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 15px;">
                                <button class="btn-secondary" onclick="editSubmission()">ìˆ˜ì •í•˜ê¸°</button>
                                <button class="btn-danger" onclick="deleteSubmission()">ì‚­ì œí•˜ê¸°</button>
                            </div>
                        </div>

                        <div id="editSubmission" style="display: none;">
                            <h3>âœï¸ ê³¼ì œ ìˆ˜ì •</h3>

                            <!-- í…ìŠ¤íŠ¸ ìˆ˜ì • -->
                            <textarea id="editSubmissionContent" class="textarea-large"></textarea>

                            <!-- íŒŒì¼ ìˆ˜ì • -->
                            <div style="margin: 15px 0;">
                                <label for="editSubmissionFile" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">
                                    ğŸ“ íŒŒì¼ ë³€ê²½ (ì„ íƒì‚¬í•­)
                                </label>
                                <input type="file"
                                       id="editSubmissionFile"
                                       accept=".pdf,.doc,.docx,.txt,.hwp,.zip,.jpg,.jpeg,.png">
                                <div id="editSubmissionFileDisplay"></div>
                                <small style="color: #7f8c8d;">
                                    íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ì´ ìœ ì§€ë©ë‹ˆë‹¤.
                                </small>
                            </div>

                            <div style="margin-top: 15px;">
                                <button class="btn-primary" onclick="updateSubmission()">ìˆ˜ì • ì™„ë£Œ</button>
                                <button class="btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Section -->
                    <div class="section-title">
                        â“ ì§ˆë¬¸í•˜ê¸°
                    </div>

                    <div class="question-form">
                        <div class="form-group">
                            <label for="questionContent">ì§ˆë¬¸ ë‚´ìš©</label>
                            <textarea id="questionContent" class="textarea-large" placeholder="ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”..." style="min-height: 120px;"></textarea>
                        </div>
                        <button class="btn-primary" onclick="submitQuestion()">ì§ˆë¬¸ ë“±ë¡</button>
                    </div>

                    <!-- Questions List -->
                    <div class="question-list" id="questionList">
                        <h3>ë‚´ê°€ í•œ ì§ˆë¬¸ë“¤</h3>
                        <div id="questionsContainer">
                            <div class="loading">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Assignment Info -->
                <div class="sidebar-section">
                    <div class="section-title">
                        â„¹ï¸ ê³¼ì œ ì •ë³´
                    </div>

                    <div class="sidebar-item">
                        <h4>ğŸ“Š ì œì¶œ í˜„í™©</h4>
                        <p id="submissionStatus">ë¯¸ì œì¶œ</p>
                    </div>

                    <div class="sidebar-item">
                        <h4>â±ï¸ ë‚¨ì€ ì‹œê°„</h4>
                        <p id="timeRemaining">ê³„ì‚° ì¤‘...</p>
                    </div>

                    <div class="sidebar-item">
                        <h4>ğŸ“‹ ì œì¶œ ì•ˆë‚´</h4>
                        <p>â€¢ ë§ˆê°ì¼ ì „ê¹Œì§€ ìˆ˜ì • ê°€ëŠ¥<br>
                            â€¢ í…ìŠ¤íŠ¸ í˜•íƒœ ë˜ëŠ” íŒŒì¼ë¡œ ì œì¶œ<br>
                            â€¢ ì§ˆë¬¸ì€ ì–¸ì œë“ ì§€ ê°€ëŠ¥</p>
                    </div>

                    <div class="sidebar-item">
                        <h4>ğŸ’¬ ì§ˆë¬¸ í˜„í™©</h4>
                        <p><span id="questionCount">0</span>ê°œì˜ ì§ˆë¬¸</p>
                    </div>

                    <div class="sidebar-item">
                        <h4>ğŸ’¯ ì·¨ë“ ì ìˆ˜</h4>
                        <p><span id="studentScore">ë¯¸ì±„ì </span>ì </p>
                    </div>

                    <div class="sidebar-item">
                        <h4>ğŸ’¬ í”¼ë“œë°±</h4>
                        <p><span id="feedback">í”¼ë“œë°± ì—†ìŒ</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì•ˆì „í•œ ìš”ì†Œ ì ‘ê·¼ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function safeGetElement(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Element with id '${id}' not found`);
        }
        return element;
    }

    function safeSetTextContent(id, content) {
        const element = safeGetElement(id);
        if (element) {
            element.textContent = content;
        }
    }

    function safeSetInnerHTML(id, content) {
        const element = safeGetElement(id);
        if (element) {
            element.innerHTML = content;
        }
    }

    function safeSetStyle(id, property, value) {
        const element = safeGetElement(id);
        if (element && element.style) {
            element.style[property] = value;
        }
    }

    function safeAddClass(id, className) {
        const element = safeGetElement(id);
        if (element && element.classList) {
            element.classList.add(className);
        }
    }

    function safeRemoveClass(id, className) {
        const element = safeGetElement(id);
        if (element && element.classList) {
            element.classList.remove(className);
        }
    }

    let currentAssignment = null;
    let currentSubmission = null;
    let assignmentCode = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
        // URLì—ì„œ ê³¼ì œ ID ì¶”ì¶œ
        const pathParts = window.location.pathname.split('/');
        assignmentCode = pathParts[pathParts.length - 1];

        if (assignmentCode) {
            loadAssignmentDetails();
            loadQuestions();
            setupFileUpload(); // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        } else {
            showError('ìœ íš¨í•˜ì§€ ì•Šì€ ê³¼ì œì…ë‹ˆë‹¤.');
        }

        // ì‹¤ì‹œê°„ ì‹œê°„ ì—…ë°ì´íŠ¸
        setInterval(updateTimeRemaining, 60000);
    });

    // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ì„¤ì •
    function setupFileUpload() {
        const submissionFile = safeGetElement('submissionFile');
        const editSubmissionFile = safeGetElement('editSubmissionFile');

        if (submissionFile) {
            submissionFile.addEventListener('change', function() {
                handleFileSelect('submissionFile', 'submissionFileDisplay');
            });
        }

        if (editSubmissionFile) {
            editSubmissionFile.addEventListener('change', function() {
                handleFileSelect('editSubmissionFile', 'editSubmissionFileDisplay');
            });
        }
    }

    // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
    function handleFileSelect(inputId, displayId) {
        const fileInput = safeGetElement(inputId);
        const fileDisplay = safeGetElement(displayId);

        if (!fileInput || !fileDisplay) return;

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const fileSize = (file.size / 1024 / 1024).toFixed(2);

            if (validateFile(file)) {
                fileDisplay.innerHTML = `
                    <div class="file-display">
                        <strong>ì„ íƒëœ íŒŒì¼:</strong> ${file.name}<br>
                        <strong>í¬ê¸°:</strong> ${fileSize} MB<br>
                        <strong>íƒ€ì…:</strong> ${file.type || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                    </div>
                `;
            } else {
                fileDisplay.innerHTML = `
                    <div class="file-display file-info-error">
                        <strong>ì˜¤ë¥˜:</strong> ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ì…ë‹ˆë‹¤.
                    </div>
                `;
                fileInput.value = '';
            }
        } else {
            fileDisplay.innerHTML = '';
        }
    }

    // íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
    function validateFile(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        const allowedExtensions = ['.pdf', '.doc', '.docx', '.txt', '.hwp', '.zip', '.jpg', '.jpeg', '.png'];
        const fileName = file.name.toLowerCase();
        const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

        if (!isValidExtension) {
            alert('í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\ní—ˆìš© í˜•ì‹: ' + allowedExtensions.join(', '));
            return false;
        }

        return true;
    }

    // ê³¼ì œ ìƒì„¸ ì •ë³´ ë¡œë“œ
    function loadAssignmentDetails() {
        fetch(`/api/student/assignment/${assignmentCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success === false) {
                    throw new Error(data.message);
                }

                currentAssignment = data;
                currentSubmission = data.submission;
                displayAssignmentDetails();
                updateSubmissionArea();

                safeSetStyle('loadingSpinner', 'display', 'none');
                safeSetStyle('mainContent', 'display', 'block');
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'ê³¼ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ê³¼ì œ ìƒì„¸ ì •ë³´ í‘œì‹œ
    function displayAssignmentDetails() {
        if (!currentAssignment) return;

        safeSetTextContent('assignmentTitle', currentAssignment.title);
        safeSetTextContent('assignmentContent', currentAssignment.content);
        safeSetTextContent('createdDate', formatDate(currentAssignment.createdDate));
        safeSetTextContent('dueDate', formatDate(currentAssignment.dueDate));

        // ì ìˆ˜ì™€ í”¼ë“œë°± í‘œì‹œ
        if (currentSubmission) {
            safeSetTextContent('studentScore',
                currentSubmission.score !== null ? currentSubmission.score : 'ë¯¸ì±„ì ');
            safeSetTextContent('feedback',
                currentSubmission.feedback || 'í”¼ë“œë°± ì—†ìŒ');
        }

        updateStatus();
        updateTimeRemaining();
    }

    // ì œì¶œ ì˜ì—­ ì—…ë°ì´íŠ¸
    function updateSubmissionArea() {
        const noSubmission = safeGetElement('noSubmission');
        const hasSubmission = safeGetElement('hasSubmission');

        if (currentSubmission) {
            if (noSubmission) noSubmission.style.display = 'none';
            if (hasSubmission) hasSubmission.style.display = 'block';

            safeSetTextContent('submittedDate', formatDate(currentSubmission.submittedDate));
            safeSetTextContent('submittedContent', currentSubmission.content);
            safeAddClass('submissionArea', 'has-submission');
            safeSetTextContent('submissionStatus', 'ì œì¶œ ì™„ë£Œ');

            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            const submittedFileInfo = safeGetElement('submittedFileInfo');
            if (currentSubmission.fileName && submittedFileInfo) {
                submittedFileInfo.style.display = 'block';
                safeSetInnerHTML('submittedFileName', `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${currentSubmission.originalFileName || currentSubmission.fileName}</span>
                        <span style="font-size: 12px; color: #7f8c8d;">
                            ${currentSubmission.fileSize ? formatFileSize(currentSubmission.fileSize) : ''}
                        </span>
                    </div>
                `);
            } else if (submittedFileInfo) {
                submittedFileInfo.style.display = 'none';
            }
        } else {
            if (noSubmission) noSubmission.style.display = 'block';
            if (hasSubmission) hasSubmission.style.display = 'none';
            safeRemoveClass('submissionArea', 'has-submission');
            safeSetTextContent('submissionStatus', 'ë¯¸ì œì¶œ');
        }
    }

    // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
    function formatFileSize(bytes) {
        if (!bytes) return '';
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    // ê³¼ì œ ì œì¶œ
    function submitAssignment() {
        const contentElement = safeGetElement('submissionContent');
        const fileInput = safeGetElement('submissionFile');

        if (!contentElement) {
            alert('ì œì¶œ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = contentElement.value.trim();
        const hasFile = fileInput && fileInput.files.length > 0;

        if (hasFile) {
            if (validateFile(fileInput.files[0])) {
                submitAssignmentWithFile();
            }
        } else {
            submitAssignmentTextOnly();
        }
    }

    // í…ìŠ¤íŠ¸ë§Œ ì œì¶œ
    function submitAssignmentTextOnly() {
        const contentElement = safeGetElement('submissionContent');
        if (!contentElement) {
            alert('ì œì¶œ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = contentElement.value.trim();
        if (!content) {
            alert('ì œì¶œí•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ê³¼ì œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        fetch('/api/student/submission', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                assignmentCode: assignmentCode,
                content: content
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ê³¼ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAssignmentDetails();
                } else {
                    alert(data.message || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // íŒŒì¼ê³¼ í•¨ê»˜ ì œì¶œ
    function submitAssignmentWithFile() {
        const contentElement = safeGetElement('submissionContent');
        const fileInput = safeGetElement('submissionFile');

        if (!contentElement || !fileInput) {
            alert('ì œì¶œ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = contentElement.value.trim();
        const file = fileInput.files[0];

        if (!content) {
            alert('ì œì¶œí•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ê³¼ì œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const formData = new FormData();
        formData.append('assignmentCode', assignmentCode);
        formData.append('content', content);

        if (file) {
            formData.append('file', file);
        }

        fetch('/api/student/submission/file', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ê³¼ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAssignmentDetails();
                } else {
                    alert(data.message || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì œì¶œë¬¼ ìˆ˜ì • ëª¨ë“œ
    function editSubmission() {
        const hasSubmission = safeGetElement('hasSubmission');
        const editSubmission = safeGetElement('editSubmission');
        const editContent = safeGetElement('editSubmissionContent');

        if (hasSubmission) hasSubmission.style.display = 'none';
        if (editSubmission) editSubmission.style.display = 'block';
        if (editContent && currentSubmission) {
            editContent.value = currentSubmission.content;
        }
    }

    // ìˆ˜ì • ì·¨ì†Œ
    function cancelEdit() {
        const hasSubmission = safeGetElement('hasSubmission');
        const editSubmission = safeGetElement('editSubmission');

        if (hasSubmission) hasSubmission.style.display = 'block';
        if (editSubmission) editSubmission.style.display = 'none';
    }

    // ì œì¶œë¬¼ ìˆ˜ì •
    function updateSubmission() {
        const fileInput = safeGetElement('editSubmissionFile');
        const hasFile = fileInput && fileInput.files.length > 0;

        if (hasFile) {
            if (validateFile(fileInput.files[0])) {
                updateSubmissionWithFile();
            }
        } else {
            updateSubmissionTextOnly();
        }
    }

    // í…ìŠ¤íŠ¸ë§Œ ìˆ˜ì •
    function updateSubmissionTextOnly() {
        const editContentElement = safeGetElement('editSubmissionContent');
        if (!editContentElement) {
            alert('ìˆ˜ì • í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = editContentElement.value.trim();
        if (!content) {
            alert('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ì œì¶œë¬¼ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        fetch('/api/student/submission', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                submissionCode: currentSubmission.submissionCode,
                content: content
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ì œì¶œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAssignmentDetails();
                } else {
                    alert(data.message || 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // íŒŒì¼ê³¼ í•¨ê»˜ ìˆ˜ì •
    function updateSubmissionWithFile() {
        const editContentElement = safeGetElement('editSubmissionContent');
        const fileInput = safeGetElement('editSubmissionFile');

        if (!editContentElement || !fileInput) {
            alert('ìˆ˜ì • í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = editContentElement.value.trim();
        const file = fileInput.files[0];

        if (!content) {
            alert('ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ì œì¶œë¬¼ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const formData = new FormData();
        formData.append('submissionCode', currentSubmission.submissionCode);
        formData.append('content', content);

        if (file) {
            formData.append('file', file);
        }

        fetch('/api/student/submission/update', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ì œì¶œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAssignmentDetails();
                } else {
                    alert(data.message || 'ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì œì¶œë¬¼ ì‚­ì œ
    function deleteSubmission() {
        if (!confirm('ì •ë§ë¡œ ì œì¶œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            return;
        }

        fetch(`/api/student/submission/${currentSubmission.submissionCode}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ì œì¶œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAssignmentDetails();
                } else {
                    alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    function downloadFile() {
        if (!currentSubmission || !currentSubmission.submissionCode) {
            alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        window.open(`/api/student/submission/${currentSubmission.submissionCode}/download`, '_blank');
    }

    // ì§ˆë¬¸ ë“±ë¡
    function submitQuestion() {
        const contentElement = safeGetElement('questionContent');
        if (!contentElement) {
            alert('ì§ˆë¬¸ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const content = contentElement.value.trim();
        if (!content) {
            alert('ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch('/api/student/question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                assignmentCode: assignmentCode,
                content: content
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('ì§ˆë¬¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    contentElement.value = '';
                    loadQuestions();
                } else {
                    alert(data.message || 'ì§ˆë¬¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì§ˆë¬¸ ëª©ë¡ ë¡œë“œ
    function loadQuestions() {
        fetch(`/api/student/assignment/${assignmentCode}/questions`)
            .then(response => response.json())
            .then(data => {
                if (Array.isArray(data)) {
                    displayQuestions(data);
                    safeSetTextContent('questionCount', data.length);
                } else {
                    throw new Error('ì§ˆë¬¸ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                safeSetInnerHTML('questionsContainer',
                    '<div class="alert alert-danger">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>');
            });
    }

    // ì§ˆë¬¸ ëª©ë¡ í‘œì‹œ
    function displayQuestions(questions) {
        const container = safeGetElement('questionsContainer');
        if (!container) return;

        if (questions.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">ì•„ì§ ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        let html = '';
        questions.forEach(question => {
            html += `
                <div class="question-item">
                    <div class="question-header">
                        <strong>Q.</strong>
                        <span class="question-date">${formatDate(question.createdDate)}</span>
                    </div>
                    <div class="question-content">${question.content}</div>
            `;

            if (question.answers && question.answers.length > 0) {
                html += '<div class="answer-list">';
                question.answers.forEach(answer => {
                    html += `
                        <div class="answer-item">
                            <div class="answer-header">
                                <span>ğŸ’¬ êµìˆ˜ë‹˜ ë‹µë³€</span>
                                <span style="font-size: 12px; color: #7f8c8d;">${formatDate(answer.createdDate)}</span>
                            </div>
                            <div class="answer-content">${answer.content}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div style="color: #7f8c8d; font-style: italic; margin-top: 10px;">ë‹µë³€ ëŒ€ê¸° ì¤‘...</div>';
            }

            html += '</div>';
        });

        container.innerHTML = html;
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus() {
        const statusBadge = safeGetElement('statusBadge');
        if (!statusBadge || !currentAssignment) return;

        const now = new Date();
        const dueDate = new Date(currentAssignment.dueDate);

        if (currentSubmission) {
            statusBadge.textContent = 'ì œì¶œ ì™„ë£Œ';
            statusBadge.className = 'status-badge status-submitted';
        } else if (now > dueDate) {
            statusBadge.textContent = 'ê¸°í•œ ë§Œë£Œ';
            statusBadge.className = 'status-badge status-overdue';
        } else {
            statusBadge.textContent = 'ë¯¸ì œì¶œ';
            statusBadge.className = 'status-badge status-pending';
        }
    }

    // ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateTimeRemaining() {
        const timeRemaining = safeGetElement('timeRemaining');
        if (!timeRemaining || !currentAssignment) return;

        const now = new Date();
        const dueDate = new Date(currentAssignment.dueDate);
        const timeDiff = dueDate - now;

        if (timeDiff <= 0) {
            timeRemaining.textContent = 'ê¸°í•œ ë§Œë£Œ';
            timeRemaining.style.color = '#dc3545';
        } else {
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) {
                timeRemaining.textContent = `${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„`;
            } else if (hours > 0) {
                timeRemaining.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;
            } else {
                timeRemaining.textContent = `${minutes}ë¶„`;
            }

            if (timeDiff < 24 * 60 * 60 * 1000) {
                timeRemaining.style.color = '#dc3545';
            } else if (timeDiff < 72 * 60 * 60 * 1000) {
                timeRemaining.style.color = '#ffc107';
            } else {
                timeRemaining.style.color = '#28a745';
            }
        }
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hour}:${minute}`;
    }

    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    function showSuccess(message) {
        const alert = safeGetElement('successAlert');
        if (alert) {
            safeSetTextContent('successMessage', message);
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
            window.scrollTo(0, 0);
        }
    }

    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    function showError(message) {
        const alert = safeGetElement('errorAlert');
        if (alert) {
            safeSetTextContent('errorMessage', message);
            alert.style.display = 'block';
            safeSetStyle('loadingSpinner', 'display', 'none');
            window.scrollTo(0, 0);
        }
    }
</script>
</body>
</html>