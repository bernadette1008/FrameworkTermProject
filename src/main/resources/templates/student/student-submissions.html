<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì œì¶œ í˜„í™© - Ploytech ê³¼ì œ ì œì¶œ ì‹œìŠ¤í…œ</title>
  <link rel="stylesheet" th:href="@{/css/student/studentStyleSheet.css}">
  <link rel="stylesheet" th:href="@{/css/student/studentSubmissionsSpecific.css}">
</head>
<body>
<div class="header">
  <a class="header-left" th:href="@{/student/main}" style="text-decoration: none;">
    <div class="logo"></div>
    <div class="title">Ploytech ê³¼ì œ ì œì¶œ ì‹œìŠ¤í…œ</div>
  </a>
  <div class="user-info">
    <span th:text="${student.name + ' í•™ìƒ'}">í•™ìƒ</span>
    <span th:text="'(' + ${student.studentId} + ')'">í•™ë²ˆ</span>
    <a th:href="@{/logout}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="container">
  <div class="sidebar">
    <a th:href="@{/student/main}" class="sidebar-item-container">
      <div class="sidebar-item">ë©”ì¸ë©”ë‰´</div>
    </a>
    <a th:href="@{/student/courses}" class="sidebar-item-container">
      <div class="sidebar-item">ìˆ˜ì—…ëª©ë¡</div>
    </a>
    <a th:href="@{/student/assignments}" class="sidebar-item-container">
      <div class="sidebar-item">ê³¼ì œ ëª©ë¡</div>
    </a>
    <a th:href="@{/student/submissions}" class="sidebar-item-container">
      <div class="sidebar-item active">ì œì¶œ ê´€ë¦¬</div>
    </a>
    <a th:href="@{/student/questions}" class="sidebar-item-container">
      <div class="sidebar-item">ì§ˆë¬¸ ê´€ë¦¬</div>
    </a>
  </div>

  <div class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-title">ğŸ“‹ ì œì¶œ í˜„í™©</div>
      <div class="page-subtitle">ë‚˜ì˜ ê³¼ì œ ì œì¶œ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</div>
    </div>

    <!-- Statistics -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number" id="totalSubmissions">0</div>
        <div class="stat-label">ì´ ì œì¶œ ê³¼ì œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="gradedSubmissions">0</div>
        <div class="stat-label">ì±„ì  ì™„ë£Œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgScore">0</div>
        <div class="stat-label">í‰ê·  ì ìˆ˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="recentSubmissions">0</div>
        <div class="stat-label">ìµœê·¼ 1ì£¼ì¼</div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-title">í•„í„°</div>
      <div class="filter-options">
        <button class="filter-btn active" onclick="filterSubmissions('all')">ì „ì²´</button>
        <button class="filter-btn" onclick="filterSubmissions('graded')">ì±„ì  ì™„ë£Œ</button>
        <button class="filter-btn" onclick="filterSubmissions('pending')">ì±„ì  ëŒ€ê¸°</button>
        <button class="filter-btn" onclick="filterSubmissions('recent')">ìµœê·¼ 1ì£¼ì¼</button>
      </div>
    </div>

    <!-- Submissions Section -->
    <div class="submissions-section">
      <div class="section-title">
        ğŸ“ ì œì¶œí•œ ê³¼ì œë“¤
      </div>
      <div id="loadingDiv" class="loading">
        <div class="loading-spinner"></div>
        ì œì¶œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>
      <div id="submissionsContainer" class="submissions-grid" style="display: none;">
        <!-- ì œì¶œë¬¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
      <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-text">ì•„ì§ ì œì¶œí•œ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-subtext">ê³¼ì œë¥¼ ì œì¶œí•˜ë©´ ì—¬ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      </div>
    </div>
  </div>
</div>

<script>
  let allSubmissions = [];
  let currentFilter = 'all';

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì œì¶œ í˜„í™© ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    loadSubmissions();
  });

  // ì œì¶œ í˜„í™© ë¡œë“œ
  function loadSubmissions() {
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('submissionsContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';

    fetch('/api/student/submissions', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    })
            .then(response => response.json())
            .then(data => {
              if (Array.isArray(data)) {
                allSubmissions = data;
                updateStatistics();
                displaySubmissions(data);
              } else if (data.success === false) {
                console.error('Error:', data.message);
                showEmptyState();
              } else {
                console.error('Invalid data format:', data);
                showEmptyState();
              }
            })
            .catch(error => {
              console.error('Error loading submissions:', error);
              showEmptyState();
            })
            .finally(() => {
              document.getElementById('loadingDiv').style.display = 'none';
            });
  }

  // í†µê³„ ì—…ë°ì´íŠ¸
  function updateStatistics() {
    const total = allSubmissions.length;
    const graded = allSubmissions.filter(s => s.score !== null && s.score !== undefined).length;
    const avgScore = graded > 0 ?
            Math.round(allSubmissions.filter(s => s.score !== null).reduce((sum, s) => sum + s.score, 0) / graded) : 0;

    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    const recent = allSubmissions.filter(s => new Date(s.submissionTime) > oneWeekAgo).length;

    document.getElementById('totalSubmissions').textContent = total;
    document.getElementById('gradedSubmissions').textContent = graded;
    document.getElementById('avgScore').textContent = avgScore > 0 ? avgScore + 'ì ' : '-';
    document.getElementById('recentSubmissions').textContent = recent;
  }

  // ì œì¶œë¬¼ í‘œì‹œ
  function displaySubmissions(submissions) {
    const container = document.getElementById('submissionsContainer');

    if (submissions.length === 0) {
      showEmptyState();
      return;
    }

    container.innerHTML = '';
    container.style.display = 'grid';
    document.getElementById('emptyState').style.display = 'none';

    submissions.forEach(submission => {
      const submissionCard = createSubmissionCard(submission);
      container.appendChild(submissionCard);
    });
  }

  // ì œì¶œë¬¼ ì¹´ë“œ ìƒì„± (DTOìš©ìœ¼ë¡œ ìˆ˜ì •ë¨)
  function createSubmissionCard(submission) {
    const card = document.createElement('div');
    card.className = 'submission-card';
    card.onclick = () => viewAssignmentDetail(submission.assignmentCode);

    const submissionDate = new Date(submission.submissionTime);
    const lastModified = submission.lastModifiedDate ? new Date(submission.lastModifiedDate) : null;

    const scoreBadge = submission.score !== null && submission.score !== undefined
            ? `<div class="score-badge score-graded">${submission.score}ì </div>`
            : `<div class="score-badge score-pending">ì±„ì  ëŒ€ê¸°</div>`;

    // DTOì—ì„œ ì§ì ‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const assignmentTitle = submission.assignmentTitle || 'ê³¼ì œ ì œëª© ì—†ìŒ';
    const courseName = submission.courseName || 'ê°•ì˜ëª… ì—†ìŒ';

    card.innerHTML = `
            <div class="submission-title">${assignmentTitle}</div>
            <div class="submission-info">
                ğŸ“š <strong>${courseName}</strong>
            </div>
            <div class="submission-info">
                ğŸ“… ì œì¶œì¼: ${submissionDate.toLocaleDateString('ko-KR')} ${submissionDate.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}
            </div>
            ${lastModified ? `<div class="submission-info">ğŸ“ ìµœì¢… ìˆ˜ì •: ${lastModified.toLocaleDateString('ko-KR')} ${lastModified.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
            <div class="submission-content">
                ${submission.content || 'ì œì¶œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}
            </div>
            <div class="submission-footer">
                ${scoreBadge}
            </div>
            ${submission.feedback ? `<div class="submission-info" style="margin-top: 10px;">ğŸ’¬ í”¼ë“œë°±: ${submission.feedback}</div>` : ''}
        `;

    return card;
  }

  // ë¹ˆ ìƒíƒœ í‘œì‹œ
  function showEmptyState() {
    document.getElementById('submissionsContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
  }

  // í•„í„°ë§
  function filterSubmissions(filterType) {
    // í•„í„° ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');

    currentFilter = filterType;
    let filteredSubmissions = allSubmissions;

    switch(filterType) {
      case 'graded':
        filteredSubmissions = allSubmissions.filter(s => s.score !== null && s.score !== undefined);
        break;
      case 'pending':
        filteredSubmissions = allSubmissions.filter(s => s.score === null || s.score === undefined);
        break;
      case 'recent':
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        filteredSubmissions = allSubmissions.filter(s => new Date(s.submissionTime) > oneWeekAgo);
        break;
      case 'all':
      default:
        filteredSubmissions = allSubmissions;
        break;
    }

    displaySubmissions(filteredSubmissions);
  }

  // ê³¼ì œ ìƒì„¸ë³´ê¸°ë¡œ ì´ë™
  function viewAssignmentDetail(assignmentCode) {
    window.location.href = `/student/assignment/${assignmentCode}`;
  }
</script>
</body>
</html>