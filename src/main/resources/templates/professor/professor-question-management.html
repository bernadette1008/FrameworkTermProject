<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>질문 관리 - Poly</title>
    <link rel="stylesheet" th:href="@{/css/professor/professorStyleSheet.css}">
    <link rel="stylesheet" th:href="@{/css/professor/professorQuestionManageStyleSheet.css}">
</head>
<body>
<div class="header">
    <a class="header-left" th:href="@{/professor-main}" style="text-decoration: none">
        <div class="logo"></div>
        <div class="title">AISW</div>
    </a>
    <div class="user-info">
        <span th:text="${professor.name + ' 교수님'}">교수님</span>
        <a th:href="@{/professor-main}" class="back-btn">← 메인으로</a>
        <a th:href="@{/logout}" class="logout-btn">로그아웃</a>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <a th:href="@{/professor-main}" class="sidebar-item-container">
            <div class="sidebar-item">대시보드</div>
        </a>
        <a th:href="@{/professor/courses}" class="sidebar-item-container">
            <div class="sidebar-item">강의 관리</div>
        </a>
        <a th:href="@{/professor/assignments}" class="sidebar-item-container">
            <div class="sidebar-item">과제 관리</div>
        </a>
        <a th:href="@{/professor/questions}" class="sidebar-item-container">
            <div class="sidebar-item active">질문 관리</div>
        </a>
    </div>

    <div class="main-content">
        <div class="page-title">질문 관리</div>

        <!-- 필터 섹션 -->
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label">강의</span>
                <select id="courseSelect" class="filter-select" onchange="onCourseChange()">
                    <option value="">모두 보기</option>
                    <option th:each="course : ${courses}"
                            th:value="${course.courseCode}"
                            th:text="${course.courseName}"
                            th:selected="${selectedCourseCode == course.courseCode}">
                        강의명
                    </option>
                </select>
            </div>

            <div class="filter-group">
                <span class="filter-label">과제</span>
                <select id="assignmentSelect" class="filter-select" onchange="onAssignmentChange()">
                    <option value="">모두 보기</option>
                    <option th:each="assignment : ${assignments}"
                            th:value="${assignment.assignmentCode}"
                            th:text="${assignment.title}"
                            th:selected="${selectedAssignmentCode == assignment.assignmentCode.toString()}">
                        과제명
                    </option>
                </select>
            </div>

            <button type="button" class="filter-btn" onclick="applyFilter()">검색</button>
        </div>

        <!-- 에러 메시지 -->
        <div th:if="${error}" class="error-message" th:text="${error}">
            에러 메시지
        </div>

        <!-- 질문 목록 -->
        <div class="questions-container">
            <div th:if="${#lists.isEmpty(questions)}" class="empty-state">
                <div class="empty-state-icon">❓</div>
                <div class="empty-state-title">질문이 없습니다</div>
                <div class="empty-state-message">
                    선택한 조건에 해당하는 질문이 없습니다.<br>
                    필터 조건을 변경해보세요.
                </div>
            </div>

            <div th:unless="${#lists.isEmpty(questions)}" class="questions-list">
                <a th:each="question : ${questions}"
                   th:href="@{'/professor/question/' + ${question.questionCode}}"
                   class="question-item"
                   th:classappend="${#lists.isEmpty(question.answers)} ? 'pending' : 'answered'">

                    <div class="question-header">
                        <div class="question-meta">
                            <div class="course-name" th:text="${question.assignment.course.courseName}">강의명</div>
                            <div class="assignment-title" th:text="${question.assignment.title}">과제명</div>
                            <div class="student-info">
                                질문자: <span th:text="${question.student.name + ' (' + question.studentId + ')'}">학생명 (학번)</span>
                            </div>
                        </div>
                        <div class="question-date">
                            <div th:text="${#temporals.format(question.questionTime, 'yyyy-MM-dd')}">2024-01-01</div>
                            <div th:text="${#temporals.format(question.questionTime, 'HH:mm')}">12:00</div>
                        </div>
                    </div>

                    <div class="question-content" th:text="${#strings.abbreviate(question.content, 200)}">
                        질문 내용이 여기에 표시됩니다...
                    </div>

                    <!-- 답변 미리보기 (답변이 있는 경우) -->
                    <div th:if="${not #lists.isEmpty(question.answers)}" class="answer-preview">
                        <div class="answer-author" th:text="${question.answers[0].professor.name + ' 교수님'}">교수님</div>
                        <div class="answer-text" th:text="${#strings.abbreviate(question.answers[0].content, 100)}">
                            답변 미리보기...
                        </div>
                    </div>

                    <div class="question-status">
                        <span th:if="${#lists.isEmpty(question.answers)}" class="status-badge status-pending">
                            답변 대기
                        </span>
                        <span th:unless="${#lists.isEmpty(question.answers)}" class="status-badge status-answered">
                            답변 완료
                        </span>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // 강의 선택 변경 시 과제 목록 업데이트
    function onCourseChange() {
        const courseSelect = document.getElementById('courseSelect');
        const assignmentSelect = document.getElementById('assignmentSelect');
        const selectedCourse = courseSelect.value;

        // 과제 선택 초기화
        assignmentSelect.innerHTML = '<option value="">모두 보기</option>';

        if (selectedCourse) {
            // AJAX로 선택된 강의의 과제 목록 가져오기
            fetch(`/professor/course/${selectedCourse}/assignments-json`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(assignments => {
                    assignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.assignmentCode;
                        option.textContent = assignment.title;
                        assignmentSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching assignments:', error);
                });
        } else {
            // 모든 강의 선택 시 모든 과제 표시
            fetch('/professor/course/all/assignments-json')
                .then(response => response.json())
                .then(assignments => {
                    assignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.assignmentCode;
                        option.textContent = assignment.title;
                        assignmentSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching assignments:', error);
                });
        }
    }

    // 과제 선택 변경 시
    function onAssignmentChange() {
        // 필요시 추가 로직 구현
    }

    // 필터 적용
    function applyFilter() {
        const courseCode = document.getElementById('courseSelect').value;
        const assignmentCode = document.getElementById('assignmentSelect').value;

        let url = '/professor/questions?';
        const params = new URLSearchParams();

        if (courseCode) {
            params.append('courseCode', courseCode);
        }
        if (assignmentCode) {
            params.append('assignmentCode', assignmentCode);
        }

        window.location.href = url + params.toString();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 페이지 로드 시 선택된 강의에 따라 과제 목록 설정
        const selectedCourse = document.getElementById('courseSelect').value;
        if (selectedCourse) {
            setTimeout(() => {
                onCourseChange();
                // 선택된 과제 복원
                const selectedAssignment = '[[${selectedAssignmentCode}]]';
                if (selectedAssignment && selectedAssignment !== 'null') {
                    setTimeout(() => {
                        document.getElementById('assignmentSelect').value = selectedAssignment;
                    }, 100);
                }
            }, 100);
        }
    });
</script>
</body>
</html>