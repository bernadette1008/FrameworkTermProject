<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³¼ì œ ì œì¶œë¬¼ ê´€ë¦¬ - Poly</title>
  <link rel="stylesheet" th:href="@{/css/professor/professorStyleSheet.css}">
  <link rel="stylesheet" th:href="@{/css/professor/professorSubmissionsStyleSheet.css}">
  <style>
    .search-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .search-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-input {
      flex: 1;
      min-width: 250px;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: #7fcdcd;
    }
    .filter-select {
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      min-width: 150px;
    }
    .reset-btn {
      padding: 12px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    .reset-btn:hover {
      background: #5a6268;
    }
    .search-info {
      margin-top: 10px;
      color: #7f8c8d;
      font-size: 14px;
    }
    .highlight {
      background-color: #fff3cd;
      padding: 2px 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
<div class="header">
  <a class="header-left" th:href="@{/professor-main}" style="text-decoration: none">
    <div class="logo"></div>
    <div class="title">AISW</div>
  </a>
  <div class="user-info">
    <span th:text="${professor.name + ' êµìˆ˜ë‹˜'}">êµìˆ˜ë‹˜</span>
    <a th:href="@{/professor/assignments}" class="back-btn">â† ê³¼ì œ ëª©ë¡</a>
  </div>
</div>

<div class="main-content" style="max-width: 1200px; width: 100%; margin: 0 auto;">
  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- Assignment Info -->
  <div class="assignment-info">
    <div class="assignment-title" th:text="${assignment.title}">ê³¼ì œ ì œëª©</div>
    <div class="assignment-meta">
      <div class="meta-item">
        <span>ğŸ“š</span>
        <span th:text="${assignment.course.courseName}">ê°•ì˜ëª…</span>
      </div>
      <div class="meta-item">
        <span>ğŸ“…</span>
        <span th:text="'ë“±ë¡ì¼: ' + ${#temporals.format(assignment.createdDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼</span>
      </div>
      <div class="meta-item">
        <span>â°</span>
        <span th:text="'ë§ˆê°ì¼: ' + ${#temporals.format(assignment.dueDate, 'yyyy-MM-dd HH:mm')}">ë§ˆê°ì¼</span>
      </div>
    </div>
    <div class="assignment-description" th:text="${assignment.content}">ê³¼ì œ ì„¤ëª…</div>
  </div>

  <!-- Statistics -->
  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-number" id="totalCount" th:text="${#lists.size(submissions)}">0</div>
      <div class="stat-label">ì´ ì œì¶œë¬¼</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="gradedCount" th:text="${submissions != null ? #lists.size(submissions.?[score != null]) : '0'}">0</div>
      <div class="stat-label">ì±„ì  ì™„ë£Œ</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="pendingCount" th:text="${submissions != null ? #lists.size(submissions.?[score == null]) : '0'}">0</div>
      <div class="stat-label">ì±„ì  ëŒ€ê¸°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" th:text="${submissions != null and !#lists.isEmpty(submissions.?[score != null]) ? (#numbers.formatDecimal((#aggregates.sum(submissions.?[score != null].![score]) / #lists.size(submissions.?[score != null])), 1, 1)) : '0.0'}">0.0</div>
      <div class="stat-label">í‰ê·  ì ìˆ˜</div>
    </div>
  </div>

  <!-- Search Section -->
  <div class="search-section">
    <div class="search-controls">
      <input type="text"
             id="searchInput"
             class="search-input"
             placeholder="ğŸ” í•™ìƒ ì´ë¦„ ë˜ëŠ” í•™ë²ˆìœ¼ë¡œ ê²€ìƒ‰..."
             onkeyup="searchSubmissions()">

      <select id="statusFilter" class="filter-select" onchange="searchSubmissions()">
        <option value="">ëª¨ë“  ìƒíƒœ</option>
        <option value="graded">ì±„ì  ì™„ë£Œ</option>
        <option value="submitted">ì œì¶œ ì™„ë£Œ</option>
        <option value="late">ì§€ê° ì œì¶œ</option>
      </select>

      <select id="sortFilter" class="filter-select" onchange="sortSubmissions()">
        <option value="date-desc">ìµœê·¼ ì œì¶œìˆœ</option>
        <option value="date-asc">ì˜¤ë˜ëœ ìˆœ</option>
        <option value="name-asc">ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)</option>
        <option value="name-desc">ì´ë¦„ìˆœ (ì—­ìˆœ)</option>
        <option value="score-desc">ì ìˆ˜ ë†’ì€ìˆœ</option>
        <option value="score-asc">ì ìˆ˜ ë‚®ì€ìˆœ</option>
      </select>

      <button class="reset-btn" onclick="resetSearch()">
        ì´ˆê¸°í™”
      </button>
    </div>
    <div id="searchInfo" class="search-info">
      <!-- ê²€ìƒ‰ ê²°ê³¼ ì •ë³´ -->
    </div>
  </div>

  <!-- Submissions Table -->
  <div class="submissions-table">
    <div class="table-header">
      <div class="table-title">ì œì¶œë¬¼ ëª©ë¡</div>
    </div>

    <div th:if="${#lists.isEmpty(submissions)}" class="empty-state" id="emptyState">
      <div class="empty-state-icon">ğŸ“‹</div>
      <h3>ì œì¶œëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ì•„ì§ í•™ìƒë“¤ì´ ê³¼ì œë¥¼ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>

    <div id="noResults" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ğŸ”</div>
      <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
    </div>

    <table th:unless="${#lists.isEmpty(submissions)}" id="submissionsTable">
      <thead>
      <tr>
        <th>í•™ìƒ</th>
        <th>ì œì¶œì¼ì‹œ</th>
        <th>ìƒíƒœ</th>
        <th>ì ìˆ˜</th>
        <th>ê´€ë¦¬</th>
      </tr>
      </thead>
      <tbody id="submissionsBody">
      <tr th:each="submission : ${submissions}"
          class="submission-row"
          th:data-student-name="${submission.student.name}"
          th:data-student-id="${submission.student.studentId}"
          th:data-status="${submission.score != null ? 'graded' : (submission.submissionTime.isBefore(assignment.dueDate) ? 'submitted' : 'late')}"
          th:data-score="${submission.score}"
          th:data-date="${submission.submissionTime}"
          th:onclick="'location.href=\'/professor/submission/' + ${submission.submissionCode} + '\''"
          style="cursor: pointer;">
        <td>
          <div class="student-info">
            <div class="student-avatar" th:text="${submission.student.name.substring(0,1)}">í•™</div>
            <div class="student-details">
              <div class="student-name" th:text="${submission.student.name}">í•™ìƒëª…</div>
              <div class="student-id" th:text="${submission.student.studentId}">í•™ë²ˆ</div>
            </div>
          </div>
        </td>
        <td th:text="${#temporals.format(submission.submissionTime, 'yyyy-MM-dd HH:mm')}">ì œì¶œì¼ì‹œ</td>
        <td>
          <span th:if="${submission.score != null}" class="submission-status status-graded">ì±„ì ì™„ë£Œ</span>
          <span th:if="${submission.score == null and submission.submissionTime.isBefore(assignment.dueDate)}"
                class="submission-status status-submitted">ì œì¶œì™„ë£Œ</span>
          <span th:if="${submission.score == null and submission.submissionTime.isAfter(assignment.dueDate)}"
                class="submission-status status-late">ì§€ê°ì œì¶œ</span>
        </td>
        <td>
          <span th:if="${submission.score != null}"
                th:class="${'score-display ' + (submission.score >= 90 ? 'score-good' : (submission.score >= 70 ? 'score-average' : 'score-poor'))}"
                th:text="${submission.score + 'ì '}">ì ìˆ˜</span>
          <span th:if="${submission.score == null}" class="submission-status" style="background: #e9ecef; color: #6c757d;">ë¯¸ì±„ì </span>
        </td>
        <td>
          <a th:href="@{'/professor/submission/' + ${submission.submissionCode}}" class="action-btn" onclick="event.stopPropagation();">
            ğŸ“ ì±„ì í•˜ê¸°
          </a>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  let allRows = [];
  const dueDate = new Date('[[${assignment.dueDate}]]');

  document.addEventListener('DOMContentLoaded', function() {
    allRows = Array.from(document.querySelectorAll('.submission-row'));
    updateSearchInfo();
  });

  function searchSubmissions() {
    const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;

    let visibleCount = 0;

    allRows.forEach(row => {
      const studentName = row.dataset.studentName.toLowerCase();
      const studentId = row.dataset.studentId.toLowerCase();
      const status = row.dataset.status;

      const matchesSearch = !searchText ||
              studentName.includes(searchText) ||
              studentId.includes(searchText);
      const matchesStatus = !statusFilter || status === statusFilter;

      if (matchesSearch && matchesStatus) {
        row.style.display = '';
        visibleCount++;

        // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
        if (searchText) {
          highlightText(row, searchText);
        } else {
          removeHighlight(row);
        }
      } else {
        row.style.display = 'none';
      }
    });

    updateSearchInfo(visibleCount, searchText, statusFilter);
    updateStatistics(visibleCount);

    // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€
    const table = document.getElementById('submissionsTable');
    const noResults = document.getElementById('noResults');
    const emptyState = document.getElementById('emptyState');

    if (visibleCount === 0 && allRows.length > 0) {
      if (table) table.style.display = 'none';
      if (noResults) noResults.style.display = 'block';
      if (emptyState) emptyState.style.display = 'none';
    } else {
      if (table) table.style.display = 'table';
      if (noResults) noResults.style.display = 'none';
    }
  }

  function sortSubmissions() {
    const sortBy = document.getElementById('sortFilter').value;
    const tbody = document.getElementById('submissionsBody');

    const sortedRows = [...allRows].sort((a, b) => {
      switch(sortBy) {
        case 'date-desc':
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        case 'date-asc':
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case 'name-asc':
          return a.dataset.studentName.localeCompare(b.dataset.studentName, 'ko');
        case 'name-desc':
          return b.dataset.studentName.localeCompare(a.dataset.studentName, 'ko');
        case 'score-desc':
          return (parseFloat(b.dataset.score) || 0) - (parseFloat(a.dataset.score) || 0);
        case 'score-asc':
          return (parseFloat(a.dataset.score) || 0) - (parseFloat(b.dataset.score) || 0);
        default:
          return 0;
      }
    });

    sortedRows.forEach(row => tbody.appendChild(row));
  }

  function highlightText(row, searchText) {
    const nameEl = row.querySelector('.student-name');
    const idEl = row.querySelector('.student-id');

    if (nameEl) {
      const name = nameEl.dataset.originalText || nameEl.textContent;
      nameEl.dataset.originalText = name;
      nameEl.innerHTML = name.replace(new RegExp(searchText, 'gi'), match => `<span class="highlight">${match}</span>`);
    }

    if (idEl) {
      const id = idEl.dataset.originalText || idEl.textContent;
      idEl.dataset.originalText = id;
      idEl.innerHTML = id.replace(new RegExp(searchText, 'gi'), match => `<span class="highlight">${match}</span>`);
    }
  }

  function removeHighlight(row) {
    const nameEl = row.querySelector('.student-name');
    const idEl = row.querySelector('.student-id');

    if (nameEl && nameEl.dataset.originalText) {
      nameEl.textContent = nameEl.dataset.originalText;
    }
    if (idEl && idEl.dataset.originalText) {
      idEl.textContent = idEl.dataset.originalText;
    }
  }

  function updateSearchInfo(visibleCount, searchText, statusFilter) {
    const info = document.getElementById('searchInfo');
    if (!info) return;

    if (visibleCount === undefined) {
      visibleCount = allRows.length;
    }

    let infoText = `ì´ ${allRows.length}ê°œ ì¤‘ ${visibleCount}ê°œ í‘œì‹œ`;

    if (searchText || statusFilter) {
      infoText += ' | í•„í„°: ';
      const filters = [];
      if (searchText) filters.push(`ê²€ìƒ‰ì–´ "${searchText}"`);
      if (statusFilter) {
        const statusNames = {
          'graded': 'ì±„ì  ì™„ë£Œ',
          'submitted': 'ì œì¶œ ì™„ë£Œ',
          'late': 'ì§€ê° ì œì¶œ'
        };
        filters.push(`ìƒíƒœ "${statusNames[statusFilter]}"`);
      }
      infoText += filters.join(', ');
    }

    info.textContent = infoText;
  }

  function updateStatistics(visibleCount) {
    const visibleRows = allRows.filter(row => row.style.display !== 'none');
    const graded = visibleRows.filter(row => row.dataset.status === 'graded').length;
    const pending = visibleRows.length - graded;

    document.getElementById('totalCount').textContent = visibleCount;
    document.getElementById('gradedCount').textContent = graded;
    document.getElementById('pendingCount').textContent = pending;
  }

  function resetSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortFilter').value = 'date-desc';

    allRows.forEach(row => {
      removeHighlight(row);
    });

    searchSubmissions();
    sortSubmissions();
  }
</script>
</body>
</html>