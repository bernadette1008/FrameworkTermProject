<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì œì¶œë¬¼ ì±„ì  - Poly</title>
  <link rel="stylesheet" th:href="@{/css/professor/professorStyleSheet.css}">
  <link rel="stylesheet" th:href="@{/css/professor/professorSubmissionDetailStyleSheet.css}">
</head>
<body>
<div class="header">
  <a class="header-left" th:href="@{/professor-main}" style="text-decoration: none">
    <div class="logo"></div>
    <div class="title">AISW</div>
  </a>
    <div class="user-info">
        <span th:text="${professor.name + ' êµìˆ˜ë‹˜'}">êµìˆ˜ë‹˜</span>
        <a th:href="@{'/professor/assignment/' + ${submission.assignment.assignmentCode} + '/submissions'}" class="back-btn">â† ì œì¶œë¬¼ ëª©ë¡</a>
        <a th:href="@{/professor-main}" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>
        <a th:href="@{/logout}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<div class="main-content" style="max-width: 1200px; width: 100%; margin: 0 auto;">
  <!-- Success/Error Messages -->
  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <div class="main-grid">
    <!-- Left: Submission Content -->
    <div class="submission-content">
      <div class="submission-header">
        <div class="submission-title" th:text="${submission.assignment.title}">ê³¼ì œ ì œëª©</div>
        <div class="submission-meta">
          <div class="meta-item">
            <span>ğŸ“š</span>
            <span th:text="${submission.assignment.course.courseName}">ê°•ì˜ëª…</span>
          </div>
          <div class="meta-item">
            <span>ğŸ“…</span>
            <span th:text="'ì œì¶œì¼: ' + ${#temporals.format(submission.submissionTime, 'yyyy-MM-dd HH:mm')}">ì œì¶œì¼</span>
          </div>
          <div class="meta-item">
            <span>â°</span>
            <span th:text="'ë§ˆê°ì¼: ' + ${#temporals.format(submission.assignment.dueDate, 'yyyy-MM-dd HH:mm')}">ë§ˆê°ì¼</span>
          </div>
          <div class="meta-item">
            <span th:if="${submission.score != null}" class="submission-status status-graded">ì±„ì ì™„ë£Œ</span>
            <span th:if="${submission.score == null and submission.submissionTime.isBefore(submission.assignment.dueDate)}"
                  class="submission-status status-submitted">ì œì¶œì™„ë£Œ</span>
            <span th:if="${submission.score == null and submission.submissionTime.isAfter(submission.assignment.dueDate)}"
                  class="submission-status status-late">ì§€ê°ì œì¶œ</span>
          </div>
        </div>
      </div>

      <div class="student-card">
        <div class="student-info">
          <div class="student-avatar" th:text="${submission.student.name.substring(0,1)}">í•™</div>
          <div class="student-details">
            <h3 th:text="${submission.student.name}">í•™ìƒ ì´ë¦„</h3>
            <div class="student-id" th:text="${submission.student.studentId}">í•™ë²ˆ</div>
          </div>
        </div>
      </div>

      <div class="section-title">
        ğŸ“ ì œì¶œ ë‚´ìš©
      </div>
      <div class="submission-text" th:text="${submission.content}">
        í•™ìƒì´ ì œì¶œí•œ ê³¼ì œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
      </div>

      <!-- ì œì¶œëœ íŒŒì¼ ì •ë³´ í‘œì‹œ -->
      <div th:if="${submission.fileName != null and !#strings.isEmpty(submission.fileName)}" style="margin-top: 25px;">
        <div class="section-title">
          ğŸ“ ì²¨ë¶€ íŒŒì¼
        </div>
        <div class="submitted-file-info">
          <div class="file-details">
            <div class="file-name">
              <span th:text="${submission.originalFileName != null ? submission.originalFileName : submission.fileName}">íŒŒì¼ëª…</span>
            </div>
            <div class="file-size" th:if="${submission.fileSize != null}">
              í¬ê¸°: <span th:text="${#numbers.formatDecimal(submission.fileSize / 1024.0 / 1024.0, 1, 2)}">0</span> MB
            </div>
            <div class="file-type" th:if="${submission.fileContentType != null}">
              í˜•ì‹: <span th:text="${submission.fileContentType}">íŒŒì¼ í˜•ì‹</span>
            </div>
          </div>
          <div class="file-actions">
            <button class="btn-download"
                    th:data-submission-code="${submission.submissionCode}"
                    onclick="downloadSubmissionFile(this.dataset.submissionCode)">
              ğŸ“¥ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
        </div>
      </div>

      <!-- ê¸°ì¡´ í”¼ë“œë°± í‘œì‹œ (ìˆëŠ” ê²½ìš°) -->
      <div th:if="${submission.feedback != null and !#strings.isEmpty(submission.feedback)}" style="margin-top: 25px;">
        <div class="section-title">
          ğŸ’¬ ì´ì „ í”¼ë“œë°±
        </div>
        <div class="submission-text" th:text="${submission.feedback}">
          ê¸°ì¡´ í”¼ë“œë°± ë‚´ìš©...
        </div>
      </div>
    </div>

    <!-- Right: Grading Panel -->
    <div class="grading-panel">
      <!-- í˜„ì¬ ì ìˆ˜ í‘œì‹œ -->
      <div th:if="${submission.score != null}" class="current-grade">
        <div class="current-score" th:text="${submission.score + 'ì '}">85ì </div>
        <div class="grade-label">í˜„ì¬ ì ìˆ˜</div>
      </div>

      <div class="section-title">
        ğŸ¯ ì±„ì í•˜ê¸°
      </div>

      <form th:action="@{'/professor/submission/' + ${submission.submissionCode} + '/grade'}" method="post" class="grading-form">
        <div class="form-group">
          <label for="score">ì ìˆ˜ (0-100ì )</label>

          <!-- ë¹ ë¥¸ ì ìˆ˜ ë²„íŠ¼ë“¤ -->
          <div class="grade-quick-buttons">
            <button type="button" class="quick-grade-btn" onclick="setScore(100)">A+ (100)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(95)">A (95)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(90)">A- (90)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(85)">B+ (85)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(80)">B (80)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(75)">B- (75)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(70)">C+ (70)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(0)">F (0)</button>
          </div>

          <!-- ì ìˆ˜ ìŠ¬ë¼ì´ë” -->
          <div class="score-input">
            <input type="range" id="scoreSlider" class="score-slider" min="0" max="100"
                   th:value="${submission.score ?: '0'}" oninput="updateScoreDisplay(this.value)">
            <input type="number" id="score" name="score" class="form-control score-display"
                   min="0" max="100" th:value="${submission.score ?: '0'}"
                   oninput="updateScoreSlider(this.value)" required>
          </div>
        </div>

        <div class="form-group">
          <label for="feedback">í”¼ë“œë°± (ì„ íƒì‚¬í•­)</label>
          <textarea id="feedback" name="feedback" class="form-control"
                    placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    th:text="${submission.feedback}"></textarea>
        </div>

        <button type="submit" class="btn-primary" id="gradeBtn">
          <span th:if="${submission.score != null}">ì ìˆ˜ ìˆ˜ì •í•˜ê¸°</span>
          <span th:if="${submission.score == null}">ì±„ì í•˜ê¸°</span>
        </button>
      </form>

      <!-- ì œì¶œ ì •ë³´ -->
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
        <div class="section-title" style="font-size: 16px;">
          â„¹ï¸ ì œì¶œ ì •ë³´
        </div>
        <div style="font-size: 14px; color: #7f8c8d; line-height: 1.6;">
          <p><strong>ì œì¶œì¼ì‹œ:</strong><br>
            <span th:text="${#temporals.format(submission.submissionTime, 'yyyy-MM-dd (E) HH:mm:ss')}">2024-01-15 (ì›”) 14:30:25</span></p>

          <p th:if="${submission.lastModifiedDate != null and !submission.lastModifiedDate.equals(submission.submissionTime)}">
            <strong>ìµœì¢… ìˆ˜ì •:</strong><br>
            <span th:text="${#temporals.format(submission.lastModifiedDate, 'yyyy-MM-dd (E) HH:mm:ss')}">ìˆ˜ì •ì¼ì‹œ</span>
          </p>

          <p><strong>ì œì¶œ ìƒíƒœ:</strong><br>
            <span th:if="${submission.submissionTime.isBefore(submission.assignment.dueDate)}" style="color: #28a745;">ì •ì‹œ ì œì¶œ</span>
            <span th:if="${submission.submissionTime.isAfter(submission.assignment.dueDate)}" style="color: #dc3545;">ì§€ê° ì œì¶œ</span>
          </p>

          <p><strong>ê¸€ì ìˆ˜:</strong> <span id="contentLength">0</span>ì</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì œì¶œ ë‚´ìš© ê¸€ì ìˆ˜ ê³„ì‚°
    const submissionText = document.querySelector('.submission-text').textContent;
    document.getElementById('contentLength').textContent = submissionText.trim().length.toLocaleString();

    // ì´ˆê¸° ì ìˆ˜ ë™ê¸°í™”
    const scoreInput = document.getElementById('score');
    const scoreSlider = document.getElementById('scoreSlider');

    // ì´ˆê¸°ê°’ ì„¤ì •
    updateScoreSlider(scoreInput.value);
    updateScoreDisplay(scoreInput.value);
  });

  // ìŠ¬ë¼ì´ë” ê°’ì´ ë³€ê²½ë  ë•Œ ìˆ«ì ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  function updateScoreDisplay(value) {
    const scoreInput = document.getElementById('score');
    const scoreSlider = document.getElementById('scoreSlider');

    scoreInput.value = value;
    scoreSlider.value = value;

    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    updateActiveButton(parseInt(value));

    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    updateScoreColor(parseInt(value));
  }

  // ìˆ«ì ì…ë ¥ í•„ë“œ ê°’ì´ ë³€ê²½ë  ë•Œ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
  function updateScoreSlider(value) {
    const scoreSlider = document.getElementById('scoreSlider');
    const scoreInput = document.getElementById('score');

    // ë²”ìœ„ ì²´í¬
    if (value < 0) value = 0;
    if (value > 100) value = 100;

    scoreSlider.value = value;
    scoreInput.value = value;

    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    updateActiveButton(parseInt(value));

    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    updateScoreColor(parseInt(value));
  }

  // ë¹ ë¥¸ ì ìˆ˜ ì„¤ì •
  function setScore(score) {
    updateScoreDisplay(score);
  }

  // í™œì„± ë²„íŠ¼ ì—…ë°ì´íŠ¸
  function updateActiveButton(score) {
    const buttons = document.querySelectorAll('.quick-grade-btn');
    buttons.forEach(button => {
      button.classList.remove('active');
      const buttonScore = parseInt(button.textContent.match(/\((\d+)\)/)[1]);
      if (buttonScore === score) {
        button.classList.add('active');
      }
    });
  }

  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  function downloadSubmissionFile(submissionCode) {
    if (!submissionCode) {
      alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    window.open(`/api/student/submission/${submissionCode}/download`, '_blank');
  }

  // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
  function updateScoreColor(score) {
    const scoreInput = document.getElementById('score');

    // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
    scoreInput.classList.remove('score-good', 'score-average', 'score-poor');

    // ì ìˆ˜ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
    if (score >= 90) {
      scoreInput.style.color = '#28a745'; // ì´ˆë¡ìƒ‰
    } else if (score >= 70) {
      scoreInput.style.color = '#ffc107'; // ë…¸ë€ìƒ‰
    } else if (score >= 0) {
      scoreInput.style.color = '#dc3545'; // ë¹¨ê°„ìƒ‰
    }
  }

  // í¼ ì œì¶œ ì‹œ í™•ì¸
  document.querySelector('.grading-form').addEventListener('submit', function(e) {
    const score = document.getElementById('score').value;
    const isUpdate = document.querySelector('[th\\:if="${submission.score != null}"]') !== null;

    const message = isUpdate ?
            `ì ìˆ˜ë¥¼ ${score}ì ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?` :
            `${score}ì ìœ¼ë¡œ ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

    if (!confirm(message)) {
      e.preventDefault();
    } else {
      // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
      const submitBtn = document.getElementById('gradeBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
    }
  });
</script>
</body>
</html>