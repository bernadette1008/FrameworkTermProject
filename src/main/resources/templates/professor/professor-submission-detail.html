<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì œì¶œë¬¼ ì±„ì  - Ploytech</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #a8e6cf, #7fcdcd);
      font-family: 'Arial', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background-color: #7fcdcd;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .logo::before {
      content: "ğŸ’¡";
      font-size: 24px;
    }

    .logout-btn {
        text-decoration: none;
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }

    .logout-btn:hover {
        background: #c0392b;
    }

    .title {
      font-size: 28px;
      font-weight: bold;
      color: #2c3e50;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
      color: #2c3e50;
      font-weight: bold;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      text-decoration: none;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .container {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }

    .submission-content, .grading-panel {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .submission-header {
      border-bottom: 2px solid #f8f9fa;
      padding-bottom: 20px;
      margin-bottom: 25px;
    }

    .submission-title {
      font-size: 28px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .submission-meta {
      display: flex;
      gap: 25px;
      color: #7f8c8d;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .student-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .student-avatar {
      width: 50px;
      height: 50px;
      background: #7fcdcd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .student-details h3 {
      margin: 0 0 5px 0;
      color: #2c3e50;
    }

    .student-id {
      color: #7f8c8d;
      font-size: 14px;
    }

    .submission-text {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      border-left: 4px solid #7fcdcd;
      line-height: 1.8;
      color: #2c3e50;
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 200px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-grade {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 25px;
    }

    .current-score {
      font-size: 32px;
      font-weight: bold;
      color: #28a745;
      margin-bottom: 5px;
    }

    .grade-label {
      color: #6c757d;
      font-size: 14px;
    }

    .grading-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .score-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-control {
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #7fcdcd;
      box-shadow: 0 0 0 3px rgba(127, 205, 205, 0.1);
    }

    .score-slider {
      flex: 1;
    }

    .score-display {
      min-width: 50px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      color: #2c3e50;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #7fcdcd, #a8e6cf);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    .btn-primary:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f1aeb5;
    }

    .submission-status {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }

    .status-graded {
      background: #cce5ff;
      color: #0066cc;
    }

    .status-submitted {
      background: #d4edda;
      color: #155724;
    }

    .status-late {
      background: #fff3cd;
      color: #856404;
    }

    .grade-quick-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .quick-grade-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: bold;
    }

    .quick-grade-btn:hover {
      background: #e9ecef;
      border-color: #7fcdcd;
    }

    .quick-grade-btn.active {
      background: #7fcdcd;
      border-color: #7fcdcd;
      color: white;
    }

    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .submission-meta {
        flex-direction: column;
        gap: 10px;
      }

      .grade-quick-buttons {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <div class="header-left">
    <div class="logo"></div>
    <div class="title">Ploytech ê³¼ì œ ì œì¶œ ì‹œìŠ¤í…œ</div>
  </div>
    <div class="user-info">
        <span th:text="${professor.name + ' êµìˆ˜ë‹˜'}">êµìˆ˜ë‹˜</span>
        <a th:href="@{'/professor/assignment/' + ${submission.assignment.assignmentCode} + '/submissions'}" class="back-btn">â† ì œì¶œë¬¼ ëª©ë¡</a>
        <a th:href="@{/professor-main}" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ</a>
        <a th:href="@{/logout}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<div class="container">
  <!-- Success/Error Messages -->
  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <div class="main-grid">
    <!-- Left: Submission Content -->
    <div class="submission-content">
      <div class="submission-header">
        <div class="submission-title" th:text="${submission.assignment.title}">ê³¼ì œ ì œëª©</div>
        <div class="submission-meta">
          <div class="meta-item">
            <span>ğŸ“š</span>
            <span th:text="${submission.assignment.course.courseName}">ê°•ì˜ëª…</span>
          </div>
          <div class="meta-item">
            <span>ğŸ“…</span>
            <span th:text="'ì œì¶œì¼: ' + ${#temporals.format(submission.submissionTime, 'yyyy-MM-dd HH:mm')}">ì œì¶œì¼</span>
          </div>
          <div class="meta-item">
            <span>â°</span>
            <span th:text="'ë§ˆê°ì¼: ' + ${#temporals.format(submission.assignment.dueDate, 'yyyy-MM-dd HH:mm')}">ë§ˆê°ì¼</span>
          </div>
          <div class="meta-item">
            <span th:if="${submission.score != null}" class="submission-status status-graded">ì±„ì ì™„ë£Œ</span>
            <span th:if="${submission.score == null and submission.submissionTime.isBefore(submission.assignment.dueDate)}"
                  class="submission-status status-submitted">ì œì¶œì™„ë£Œ</span>
            <span th:if="${submission.score == null and submission.submissionTime.isAfter(submission.assignment.dueDate)}"
                  class="submission-status status-late">ì§€ê°ì œì¶œ</span>
          </div>
        </div>
      </div>

      <div class="student-card">
        <div class="student-info">
          <div class="student-avatar" th:text="${submission.student.name.substring(0,1)}">í•™</div>
          <div class="student-details">
            <h3 th:text="${submission.student.name}">í•™ìƒ ì´ë¦„</h3>
            <div class="student-id" th:text="${submission.student.studentId}">í•™ë²ˆ</div>
          </div>
        </div>
      </div>

      <div class="section-title">
        ğŸ“ ì œì¶œ ë‚´ìš©
      </div>
      <div class="submission-text" th:text="${submission.content}">
        í•™ìƒì´ ì œì¶œí•œ ê³¼ì œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
      </div>

      <!-- ê¸°ì¡´ í”¼ë“œë°± í‘œì‹œ (ìˆëŠ” ê²½ìš°) -->
      <div th:if="${submission.feedback != null and !#strings.isEmpty(submission.feedback)}" style="margin-top: 25px;">
        <div class="section-title">
          ğŸ’¬ ì´ì „ í”¼ë“œë°±
        </div>
        <div class="submission-text" th:text="${submission.feedback}">
          ê¸°ì¡´ í”¼ë“œë°± ë‚´ìš©...
        </div>
      </div>
    </div>

    <!-- Right: Grading Panel -->
    <div class="grading-panel">
      <!-- í˜„ì¬ ì ìˆ˜ í‘œì‹œ -->
      <div th:if="${submission.score != null}" class="current-grade">
        <div class="current-score" th:text="${submission.score + 'ì '}">85ì </div>
        <div class="grade-label">í˜„ì¬ ì ìˆ˜</div>
      </div>

      <div class="section-title">
        ğŸ¯ ì±„ì í•˜ê¸°
      </div>

      <form th:action="@{'/professor/submission/' + ${submission.submissionCode} + '/grade'}" method="post" class="grading-form">
        <div class="form-group">
          <label for="score">ì ìˆ˜ (0-100ì )</label>

          <!-- ë¹ ë¥¸ ì ìˆ˜ ë²„íŠ¼ë“¤ -->
          <div class="grade-quick-buttons">
            <button type="button" class="quick-grade-btn" onclick="setScore(100)">A+ (100)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(95)">A (95)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(90)">A- (90)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(85)">B+ (85)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(80)">B (80)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(75)">B- (75)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(70)">C+ (70)</button>
            <button type="button" class="quick-grade-btn" onclick="setScore(0)">F (0)</button>
          </div>

          <!-- ì ìˆ˜ ìŠ¬ë¼ì´ë” -->
          <div class="score-input">
            <input type="range" id="scoreSlider" class="score-slider" min="0" max="100"
                   th:value="${submission.score ?: '0'}" oninput="updateScoreDisplay(this.value)">
            <input type="number" id="score" name="score" class="form-control score-display"
                   min="0" max="100" th:value="${submission.score ?: '0'}"
                   oninput="updateScoreSlider(this.value)" required>
          </div>
        </div>

        <div class="form-group">
          <label for="feedback">í”¼ë“œë°± (ì„ íƒì‚¬í•­)</label>
          <textarea id="feedback" name="feedback" class="form-control"
                    placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    th:text="${submission.feedback}"></textarea>
        </div>

        <button type="submit" class="btn-primary" id="gradeBtn">
          <span th:if="${submission.score != null}">ì ìˆ˜ ìˆ˜ì •í•˜ê¸°</span>
          <span th:if="${submission.score == null}">ì±„ì í•˜ê¸°</span>
        </button>
      </form>

      <!-- ì œì¶œ ì •ë³´ -->
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
        <div class="section-title" style="font-size: 16px;">
          â„¹ï¸ ì œì¶œ ì •ë³´
        </div>
        <div style="font-size: 14px; color: #7f8c8d; line-height: 1.6;">
          <p><strong>ì œì¶œì¼ì‹œ:</strong><br>
            <span th:text="${#temporals.format(submission.submissionTime, 'yyyy-MM-dd (E) HH:mm:ss')}">2024-01-15 (ì›”) 14:30:25</span></p>

          <p th:if="${submission.lastModifiedDate != null and !submission.lastModifiedDate.equals(submission.submissionTime)}">
            <strong>ìµœì¢… ìˆ˜ì •:</strong><br>
            <span th:text="${#temporals.format(submission.lastModifiedDate, 'yyyy-MM-dd (E) HH:mm:ss')}">ìˆ˜ì •ì¼ì‹œ</span>
          </p>

          <p><strong>ì œì¶œ ìƒíƒœ:</strong><br>
            <span th:if="${submission.submissionTime.isBefore(submission.assignment.dueDate)}" style="color: #28a745;">ì •ì‹œ ì œì¶œ</span>
            <span th:if="${submission.submissionTime.isAfter(submission.assignment.dueDate)}" style="color: #dc3545;">ì§€ê° ì œì¶œ</span>
          </p>

          <p><strong>ê¸€ì ìˆ˜:</strong> <span id="contentLength">0</span>ì</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì œì¶œ ë‚´ìš© ê¸€ì ìˆ˜ ê³„ì‚°
    const submissionText = document.querySelector('.submission-text').textContent;
    document.getElementById('contentLength').textContent = submissionText.trim().length.toLocaleString();

    // ì´ˆê¸° ì ìˆ˜ ë™ê¸°í™”
    const scoreInput = document.getElementById('score');
    const scoreSlider = document.getElementById('scoreSlider');

    // ì´ˆê¸°ê°’ ì„¤ì •
    updateScoreSlider(scoreInput.value);
    updateScoreDisplay(scoreInput.value);
  });

  // ìŠ¬ë¼ì´ë” ê°’ì´ ë³€ê²½ë  ë•Œ ìˆ«ì ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
  function updateScoreDisplay(value) {
    const scoreInput = document.getElementById('score');
    const scoreSlider = document.getElementById('scoreSlider');

    scoreInput.value = value;
    scoreSlider.value = value;

    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    updateActiveButton(parseInt(value));

    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    updateScoreColor(parseInt(value));
  }

  // ìˆ«ì ì…ë ¥ í•„ë“œ ê°’ì´ ë³€ê²½ë  ë•Œ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
  function updateScoreSlider(value) {
    const scoreSlider = document.getElementById('scoreSlider');
    const scoreInput = document.getElementById('score');

    // ë²”ìœ„ ì²´í¬
    if (value < 0) value = 0;
    if (value > 100) value = 100;

    scoreSlider.value = value;
    scoreInput.value = value;

    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    updateActiveButton(parseInt(value));

    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    updateScoreColor(parseInt(value));
  }

  // ë¹ ë¥¸ ì ìˆ˜ ì„¤ì •
  function setScore(score) {
    updateScoreDisplay(score);
  }

  // í™œì„± ë²„íŠ¼ ì—…ë°ì´íŠ¸
  function updateActiveButton(score) {
    const buttons = document.querySelectorAll('.quick-grade-btn');
    buttons.forEach(button => {
      button.classList.remove('active');
      const buttonScore = parseInt(button.textContent.match(/\((\d+)\)/)[1]);
      if (buttonScore === score) {
        button.classList.add('active');
      }
    });
  }

  // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
  function updateScoreColor(score) {
    const scoreInput = document.getElementById('score');

    // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
    scoreInput.classList.remove('score-good', 'score-average', 'score-poor');

    // ì ìˆ˜ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¶”ê°€
    if (score >= 90) {
      scoreInput.style.color = '#28a745'; // ì´ˆë¡ìƒ‰
    } else if (score >= 70) {
      scoreInput.style.color = '#ffc107'; // ë…¸ë€ìƒ‰
    } else if (score >= 0) {
      scoreInput.style.color = '#dc3545'; // ë¹¨ê°„ìƒ‰
    }
  }

  // í¼ ì œì¶œ ì‹œ í™•ì¸
  document.querySelector('.grading-form').addEventListener('submit', function(e) {
    const score = document.getElementById('score').value;
    const isUpdate = document.querySelector('[th\\:if="${submission.score != null}"]') !== null;

    const message = isUpdate ?
            `ì ìˆ˜ë¥¼ ${score}ì ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?` :
            `${score}ì ìœ¼ë¡œ ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

    if (!confirm(message)) {
      e.preventDefault();
    } else {
      // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
      const submitBtn = document.getElementById('gradeBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
    }
  });
</script>
</body>
</html>