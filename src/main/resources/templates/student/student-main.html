<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ploytech 과제 제출 시스템</title>
    <link rel="stylesheet" th:href="@{/css/student/studentMainStyleSheet.css}">
</head>
<body>
<div class="header">
    <a class="header-left" th:href="@{/student/main}" style="text-decoration: none;">
        <div class="logo"></div>
        <div class="title">Ploytech 과제 제출 시스템</div>
    </a>
    <div class="user-info">
        <span th:text="${student.name + ' 학생'}">학생</span>
        <span th:text="'(' + ${student.studentId} + ')'">학번</span>
        <a th:href="@{/logout}" class="logout-btn">로그아웃</a>
    </div>
</div>

<div class="container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-title" th:text="${student.name + '님, 환영합니다! 🎓'}">학생님, 환영합니다!</div>
        <div class="welcome-subtitle">학습 관리를 효율적으로 해보세요</div>

        <div class="action-buttons">
            <a class="action-btn" th:href="@{/student/courses}">
                📚 수업 목록 & 등록
            </a>
            <a class="action-btn" th:href="@{/student/assignments}">
                📝 과제 목록
            </a>
            <a class="action-btn" th:href="@{/student/submissions}">
                📋 제출 현황
            </a>
            <a class="action-btn" th:href="@{/student/questions}">
                ❓ 내 질문
            </a>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="main-grid">
        <!-- 수강 중인 과목 -->
        <div class="section-card">
            <div class="section-title">
                📚 수강 중인 과목
            </div>
            <div class="stats-section">
                <div class="stat-item">
                    <div class="stat-number" id="courseCount" th:text="${#lists.size(courses)}">0</div>
                    <div class="stat-label">수강 과목</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="assignmentCount" th:text="${#lists.size(assignments)}">0</div>
                    <div class="stat-label">전체 과제</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="submissionCount" th:text="${#lists.size(submissions)}">0</div>
                    <div class="stat-label">제출 완료</div>
                </div>
            </div>
            <div id="courseList" class="course-list">
                <div th:if="${#lists.isEmpty(courses)}" class="empty-state">
                    <div class="empty-state-icon">📚</div>
                    <div>아직 수강된 강의가 없습니다.<br>새 강의를 추가해보세요!</div>
                </div>
                <div th:unless="${#lists.isEmpty(courses)}" class="course-grid">
                    <div th:each="course : ${courses}" class="course-card">
                        <div class="card-title" th:text="${course.courseName}">강의명</div>
                        <div class="card-info">강의 코드: <span th:text="${course.courseCode}">CS101</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 최근 과제 -->
        <div class="section-card">
            <div class="section-title">
                📝 미제출 과제
            </div>
            <div id="assignmentList" class="assignment-list">
                <!-- 최근 과제 목록 -->
                <div class="content-section">
                    <div th:if="${#lists.isEmpty(assignments)}" class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div>아직 등록된 과제가 없습니다.</div>
                    </div>
                    <div th:unless="${#lists.isEmpty(assignments)}" class="assignment-grid">
                        <a style="text-decoration: none; color: black;" th:each="assignment : ${assignments}" th:href="@{/student/assignment/{code}(code=${assignment.assignmentCode})}">
                            <div class="assignment-card">
                                <div class="card-title" th:text="${assignment.title}">과제명</div>
                                <div class="card-info">강의: <span th:text="${assignment.course.courseName}">강의명</span></div>
                                <div class="card-info">마감일: <span th:text="${assignment.dueDate}">마감일</span></div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 수업 등록 Modal -->
<div id="enrollModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEnrollModal()">&times;</span>
        <div class="modal-title">수업 등록</div>
        <form onsubmit="enrollInCourse(event)">
            <div class="form-group">
                <label for="courseKey">수업 코드</label>
                <input type="text" id="courseKey" class="form-control" placeholder="교수님이 제공한 수업 코드를 입력하세요" required>
            </div>
            <div style="text-align: center;">
                <button type="submit" class="btn-primary">등록하기</button>
                <button type="button" class="btn-secondary" onclick="closeEnrollModal()">취소</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 페이지 로드 시 초기 데이터 로드
    document.addEventListener('DOMContentLoaded', function() {
        // 세션에서 학생 ID 저장 (실제로는 서버에서 설정해야 함)
        sessionStorage.setItem('userId', /*[[${student.studentId}]]*/ 'STUDENT001');

        loadCourses();
        loadAssignments();
    });

    // 수업 등록 모달 열기
    function openEnrollModal() {
        document.getElementById('enrollModal').style.display = 'block';
    }

    // 수업 등록 모달 닫기
    function closeEnrollModal() {
        document.getElementById('enrollModal').style.display = 'none';
        document.getElementById('courseKey').value = '';
    }

    // 수업 등록
    function enrollInCourse(event) {
        event.preventDefault();
        const courseKey = document.getElementById('courseKey').value.trim();

        if (!courseKey) {
            alert('수업 코드를 입력해주세요.');
            return;
        }

        fetch('/api/student/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                courseKey: courseKey
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeEnrollModal();
                    loadCourses(); // 수업 목록 새로고침
                    loadAssignments(); // 과제 목록 새로고침
                } else {
                    alert(data.message || '등록에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('네트워크 오류가 발생했습니다.');
            });
    }

    // Modal 외부 클릭 시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('enrollModal');
        if (event.target === modal) {
            closeEnrollModal();
        }
    }
</script>
</body>
</html>