<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼ì œ ëª©ë¡ - Poly</title>
    <link rel="stylesheet" th:href="@{/css/student/studentStyleSheet.css}">
    <link rel="stylesheet" th:href="@{/css/student/studentAssignmentsSpecific.css}">
</head>
<body>
<div class="header">
    <a class="header-left" th:href="@{/student/main}" style="text-decoration: none;">
        <div class="logo"></div>
        <div class="title">Poly</div>
    </a>
    <div class="user-info">
        <span th:text="${student.name + ' í•™ìƒ'}">í•™ìƒ</span>
        <span th:text="'(' + ${student.studentId} + ')'">í•™ë²ˆ</span>
        <a th:href="@{/logout}" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <a th:href="@{/student/main}" class="sidebar-item-container">
            <div class="sidebar-item">ë©”ì¸ë©”ë‰´</div>
        </a>
        <a th:href="@{/student/courses}" class="sidebar-item-container">
            <div class="sidebar-item">ìˆ˜ì—…ëª©ë¡</div>
        </a>
        <a th:href="@{/student/assignments}" class="sidebar-item-container">
            <div class="sidebar-item active">ê³¼ì œ ëª©ë¡</div>
        </a>
        <a th:href="@{/student/submissions}" class="sidebar-item-container">
            <div class="sidebar-item">ì œì¶œ ê´€ë¦¬</div>
        </a>
        <a th:href="@{/student/questions}" class="sidebar-item-container">
            <div class="sidebar-item">ì§ˆë¬¸ ê´€ë¦¬</div>
        </a>
    </div>

    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-title">ğŸ“ ê³¼ì œ ëª©ë¡</div>
            <div class="page-subtitle">ë‚´ ê³¼ì œë¥¼ í•œëˆˆì— í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</div>
        </div>

        <!-- Error Message -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- Statistics Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" th:text="${#lists.size(assignments)}">0</div>
                <div class="stat-label">ì „ì²´ ê³¼ì œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="submittedCount">0</div>
                <div class="stat-label">ì œì¶œ ì™„ë£Œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">ë¯¸ì œì¶œ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="overdueCount">0</div>
                <div class="stat-label">ê¸°í•œ ì´ˆê³¼</div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="statusFilter">ìƒíƒœ:</label>
                <select id="statusFilter" class="filter-select" onchange="filterAssignments()">
                    <option value="all">ì „ì²´</option>
                    <option value="pending">ë¯¸ì œì¶œ</option>
                    <option value="submitted">ì œì¶œì™„ë£Œ</option>
                    <option value="overdue">ê¸°í•œì´ˆê³¼</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="courseFilter">ê°•ì˜:</label>
                <select id="courseFilter" class="filter-select" onchange="filterAssignments()">
                    <option value="all">ì „ì²´ ê°•ì˜</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortFilter">ì •ë ¬:</label>
                <select id="sortFilter" class="filter-select" onchange="sortAssignments()">
                    <option value="dueDate">ë§ˆê°ì¼ìˆœ</option>
                    <option value="createdDate">ìƒì„±ì¼ìˆœ</option>
                    <option value="title">ì œëª©ìˆœ</option>
                </select>
            </div>
        </div>

        <!-- Assignments Grid -->
        <div id="assignmentsContainer">
            <div th:if="${#lists.isEmpty(assignments)}" class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <h3>ì•„ì§ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ìˆ˜ì—…ì„ ë“±ë¡í•˜ë©´ ê³¼ì œë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!</p>
                <a th:href="@{/student/main}" class="btn-primary">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>

            <div th:unless="${#lists.isEmpty(assignments)}" class="assignments-grid" id="assignmentsGrid">
                <a th:each="assignment : ${assignments}"
                   class="assignment-card"
                   th:href="@{/student/assignment/{code}(code=${assignment.assignmentCode})}"
                   th:data-status="${assignment.isSubmitted() ? 'submitted' : (assignment.isOverdue() ? 'overdue' : 'pending')}"
                   th:data-course="${assignment.course.courseCode}"
                   th:data-due-date="${assignment.dueDate}"
                   th:data-created-date="${assignment.createdDate}"
                   th:data-title="${assignment.title}">

                    <div class="assignment-header">
                        <h3 class="assignment-title" th:text="${assignment.title}">ê³¼ì œ ì œëª©</h3>
                        <span class="status-badge"
                              th:class="${'status-badge ' + (assignment.isSubmitted() ? 'status-submitted' : (assignment.isOverdue() ? 'status-overdue' : 'status-pending'))}"
                              th:text="${assignment.isSubmitted() ? 'ì œì¶œì™„ë£Œ' : (assignment.isOverdue() ? 'ê¸°í•œì´ˆê³¼' : 'ë¯¸ì œì¶œ')}">ìƒíƒœ</span>
                    </div>

                    <div class="course-info">
                        <span>ğŸ“š</span>
                        <span th:text="${assignment.course.courseName}">ê°•ì˜ëª…</span>
                        <span th:text="'(' + ${assignment.course.courseCode} + ')'">ê°•ì˜ì½”ë“œ</span>
                    </div>

                    <div class="assignment-description" th:text="${assignment.content}">
                        ê³¼ì œ ì„¤ëª…...
                    </div>

                    <div class="assignment-dates">
                        <div class="date-item">
                            <span class="date-icon">ğŸ“…</span>
                            <span th:text="'ìƒì„±: ' + ${#temporals.format(assignment.createdDate, 'yyyy-MM-dd HH:mm')}">ìƒì„±ì¼</span>
                        </div>
                        <div class="date-item">
                            <span class="date-icon">â°</span>
                            <span th:text="'ë§ˆê°: ' + ${#temporals.format(assignment.dueDate, 'yyyy-MM-dd HH:mm')}">ë§ˆê°ì¼</span>
                        </div>
                    </div>

                    <div class="time-remaining"
                         th:data-due-date="${assignment.dueDate}"
                         th:data-is-submitted="${assignment.isSubmitted()}">
                        ì‹œê°„ ê³„ì‚° ì¤‘...
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let allAssignments = [];

    document.addEventListener('DOMContentLoaded', function() {
        // ê³¼ì œ ë°ì´í„° ì €ì¥
        const assignmentCards = document.querySelectorAll('.assignment-card');
        allAssignments = Array.from(assignmentCards).map(card => ({
            element: card,
            status: card.dataset.status,
            course: card.dataset.course,
            dueDate: new Date(card.dataset.dueDate),
            createdDate: new Date(card.dataset.createdDate),
            title: card.dataset.title
        }));

        // ê°•ì˜ í•„í„° ì˜µì…˜ ì„¤ì •
        setupCourseFilter();

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStatistics();

        // ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
        updateTimeRemaining();

        // 1ë¶„ë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
        setInterval(updateTimeRemaining, 60000);
    });

    function setupCourseFilter() {
        const courseFilter = document.getElementById('courseFilter');
        const courses = new Set();

        allAssignments.forEach(assignment => {
            courses.add(assignment.course);
        });

        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            courseFilter.appendChild(option);
        });
    }

    function updateStatistics() {
        const submitted = allAssignments.filter(a => a.status === 'submitted').length;
        const pending = allAssignments.filter(a => a.status === 'pending').length;
        const overdue = allAssignments.filter(a => a.status === 'overdue').length;

        document.getElementById('submittedCount').textContent = submitted;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('overdueCount').textContent = overdue;
    }

    function filterAssignments() {
        const statusFilter = document.getElementById('statusFilter').value;
        const courseFilter = document.getElementById('courseFilter').value;

        allAssignments.forEach(assignment => {
            let show = true;

            // ìƒíƒœ í•„í„°
            if (statusFilter !== 'all' && assignment.status !== statusFilter) {
                show = false;
            }

            // ê°•ì˜ í•„í„°
            if (courseFilter !== 'all' && assignment.course !== courseFilter) {
                show = false;
            }

            assignment.element.style.display = show ? 'block' : 'none';
        });
    }

    function sortAssignments() {
        const sortBy = document.getElementById('sortFilter').value;
        const container = document.getElementById('assignmentsGrid');

        const sortedAssignments = [...allAssignments].sort((a, b) => {
            switch (sortBy) {
                case 'dueDate':
                    return a.dueDate - b.dueDate;
                case 'createdDate':
                    return b.createdDate - a.createdDate;
                case 'title':
                    return a.title.localeCompare(b.title);
                default:
                    return 0;
            }
        });

        // DOM ì¬ì •ë ¬
        sortedAssignments.forEach(assignment => {
            container.appendChild(assignment.element);
        });
    }

    function updateTimeRemaining() {
        const timeElements = document.querySelectorAll('.time-remaining');
        const now = new Date();

        timeElements.forEach(element => {
            const dueDate = new Date(element.dataset.dueDate);
            const isSubmitted = element.dataset.isSubmitted === 'true';
            const timeDiff = dueDate - now;

            if (isSubmitted) {
                element.textContent = 'âœ… ì œì¶œì™„ë£Œ';
                element.className = 'time-remaining time-normal';
            } else if (timeDiff <= 0) {
                element.textContent = 'âš ï¸ ê¸°í•œë§Œë£Œ';
                element.className = 'time-remaining time-danger';
            } else {
                const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));

                let timeText = '';
                if (days > 0) {
                    timeText = `${days}ì¼ ${hours}ì‹œê°„ ë‚¨ìŒ`;
                } else if (hours > 0) {
                    timeText = `${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
                } else {
                    timeText = `${minutes}ë¶„ ë‚¨ìŒ`;
                }

                element.textContent = `â° ${timeText}`;

                // ì‹œê°„ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                if (timeDiff < 24 * 60 * 60 * 1000) { // 24ì‹œê°„ ë¯¸ë§Œ
                    element.className = 'time-remaining time-danger';
                } else if (timeDiff < 72 * 60 * 60 * 1000) { // 72ì‹œê°„ ë¯¸ë§Œ
                    element.className = 'time-remaining time-warning';
                } else {
                    element.className = 'time-remaining time-normal';
                }
            }
        });
    }

    function viewAssignment(assignmentCode) {
        window.location.href = `/student/assignment/${assignmentCode}`;
    }
</script>
</body>
</html>